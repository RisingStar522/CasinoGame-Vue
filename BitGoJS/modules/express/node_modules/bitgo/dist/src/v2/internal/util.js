"use strict";
/**
 * @prettier
 * @hidden
 */
Object.defineProperty(exports, "__esModule", { value: true });
/**
 */
var bitcoin = require("@bitgo/utxo-lib");
var Big = require("big.js");
var _ = require("lodash");
var crypto_1 = require("crypto");
var debugLib = require("debug");
var errors_1 = require("../../errors");
var debug = debugLib('bitgo:v2:util');
var ethUtil;
var isEthAvailable = false;
var ethImport = 'ethereumjs-util';
Promise.resolve().then(function () { return require('ethereumjs-util'); }).then(function (eth) {
    ethUtil = eth;
    isEthAvailable = true;
})
    .catch(function (e) {
    // ethereum currently not supported
    debug('unable to load ethereumjs-util:');
    debug(e.stack);
});
/**
 * Create a request tracer for tracing workflows which involve multiple round trips to the server
 */
var RequestTracer = /** @class */ (function () {
    function RequestTracer() {
        this._seq = 0;
        this._seed = crypto_1.randomBytes(10);
    }
    RequestTracer.prototype.inc = function () {
        this._seq++;
    };
    RequestTracer.prototype.toString = function () {
        return this._seed.toString('hex') + "-" + _.padStart(this._seq.toString(16), 4, '0');
    };
    return RequestTracer;
}());
exports.RequestTracer = RequestTracer;
var Util = /** @class */ (function () {
    function Util() {
    }
    /**
     * @deprecated
     */
    Util.isEthAvailable = function () {
        return isEthAvailable;
    };
    /**
     * Convert a big.js big number to an array of unsigned bytes
     * @param bn
     * @deprecated
     */
    Util.bnToByteArrayUnsigned = function (bn) {
        var ba = bn.abs().toByteArray();
        if (ba.length) {
            if (ba[0] === 0) {
                ba = ba.slice(1);
            }
            return ba.map(function (v) {
                return v < 0 ? v + 256 : v;
            });
        }
        else {
            // Empty array, nothing to do
            return ba;
        }
    };
    /**
     * Generate the output script for a BTC P2SH multisig address
     * @param m
     * @param pubKeys
     * @deprecated
     */
    Util.p2shMultisigOutputScript = function (m, pubKeys) {
        var redeemScript = bitcoin.script.multisig.output.encode(m, pubKeys);
        var hash = bitcoin.crypto.hash160(redeemScript);
        return bitcoin.script.scriptHash.output.encode(hash);
    };
    /**
     * Utility method for handling arguments of pageable queries
     * @param params
     * @deprecated
     */
    Util.preparePageableQuery = function (params) {
        if (params === void 0) { params = {}; }
        var query = {};
        if (params.limit) {
            if (!_.isNumber(params.limit)) {
                throw new Error('invalid limit argument, expecting number');
            }
            query.limit = params.limit;
        }
        if (params.skip) {
            if (!_.isNumber(params.skip)) {
                throw new Error('invalid skip argument, expecting number');
            }
            query.skip = params.skip;
        }
        return query;
    };
    /**
     * Create a request identifier for tracing multi-request workflows
     */
    Util.createRequestId = function () {
        return new RequestTracer();
    };
    /**
     * Convert a BTC xpub to an Ethereum address (with 0x) prefix
     * @param xpub
     * @deprecated
     */
    Util.xpubToEthAddress = function (xpub) {
        if (!isEthAvailable) {
            throw new errors_1.EthereumLibraryUnavailableError(ethImport);
        }
        var hdNode = bitcoin.HDNode.fromBase58(xpub);
        var ethPublicKey = hdNode.keyPair.__Q.getEncoded(false).slice(1);
        return ethUtil.bufferToHex(ethUtil.publicToAddress(ethPublicKey, false));
    };
    /**
     * Convert a BTC xpriv to an Ethereum private key (without 0x prefix)
     * @param xprv
     * @deprecated
     */
    Util.xprvToEthPrivateKey = function (xprv) {
        var hdNode = bitcoin.HDNode.fromBase58(xprv);
        var ethPrivateKey = hdNode.keyPair.d.toBuffer(32);
        return ethPrivateKey.toString('hex');
    };
    /**
     * Sign a message using Ethereum's ECsign method and return the signature string
     * @param msgHash
     * @param privKey
     * @deprecated
     */
    Util.ethSignMsgHash = function (msgHash, privKey) {
        if (!isEthAvailable) {
            throw new errors_1.EthereumLibraryUnavailableError(ethImport);
        }
        var signatureInParts = ethUtil.ecsign(Buffer.from(ethUtil.stripHexPrefix(msgHash), 'hex'), Buffer.from(privKey, 'hex'));
        // Assemble strings from r, s and v
        var r = ethUtil.setLengthLeft(signatureInParts.r, 32).toString('hex');
        var s = ethUtil.setLengthLeft(signatureInParts.s, 32).toString('hex');
        var v = ethUtil.stripHexPrefix(ethUtil.intToHex(signatureInParts.v));
        // Concatenate the r, s and v parts to make the signature string
        return ethUtil.addHexPrefix(r.concat(s, v));
    };
    /**
     * Convert from wei string (or BN) to Ether (multiply by 1e18)
     * @param wei
     * @deprecated
     */
    Util.weiToEtherString = function (wei) {
        if (!isEthAvailable) {
            throw new errors_1.EthereumLibraryUnavailableError(ethImport);
        }
        var bn = wei;
        if (!(wei instanceof ethUtil.BN)) {
            bn = new ethUtil.BN(wei);
        }
        Big.E_POS = 256;
        Big.E_NEG = -18;
        var weiString = bn.toString(10);
        var big = new Big(weiString);
        // 10^18
        var ether = big.div('1000000000000000000');
        return ether.toPrecision();
    };
    /**
     * Recover an ethereum address from a signature and message hash
     * @param msgHash
     * @param signature
     * @deprecated
     */
    Util.ecRecoverEthAddress = function (msgHash, signature) {
        msgHash = ethUtil.stripHexPrefix(msgHash);
        signature = ethUtil.stripHexPrefix(signature);
        var v = parseInt(signature.slice(128, 130), 16);
        var r = Buffer.from(signature.slice(0, 64), 'hex');
        var s = Buffer.from(signature.slice(64, 128), 'hex');
        var pubKey = ethUtil.ecrecover(Buffer.from(msgHash, 'hex'), v, r, s);
        return ethUtil.bufferToHex(ethUtil.pubToAddress(pubKey));
    };
    return Util;
}());
exports.Util = Util;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy92Mi9pbnRlcm5hbC91dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7O0FBRUg7R0FDRztBQUNILHlDQUEyQztBQUMzQyw0QkFBOEI7QUFDOUIsMEJBQTRCO0FBQzVCLGlDQUFxQztBQUNyQyxnQ0FBa0M7QUFDbEMsdUNBQStEO0FBRy9ELElBQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUV4QyxJQUFJLE9BQU8sQ0FBQztBQUNaLElBQUksY0FBYyxHQUFHLEtBQUssQ0FBQztBQUUzQixJQUFNLFNBQVMsR0FBRyxpQkFBaUIsQ0FBQztBQUNwQyxvREFBTyxpQkFBaUIsTUFDckIsSUFBSSxDQUFDLFVBQUEsR0FBRztJQUNQLE9BQU8sR0FBRyxHQUFHLENBQUM7SUFDZCxjQUFjLEdBQUcsSUFBSSxDQUFDO0FBQ3hCLENBQUMsQ0FBQztLQUNELEtBQUssQ0FBQyxVQUFBLENBQUM7SUFDTixtQ0FBbUM7SUFDbkMsS0FBSyxDQUFDLGlDQUFpQyxDQUFDLENBQUM7SUFDekMsS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUNqQixDQUFDLENBQUMsQ0FBQztBQUVMOztHQUVHO0FBQ0g7SUFHRTtRQUZRLFNBQUksR0FBRyxDQUFDLENBQUM7UUFHZixJQUFJLENBQUMsS0FBSyxHQUFHLG9CQUFXLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQUVELDJCQUFHLEdBQUg7UUFDRSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDZCxDQUFDO0lBRUQsZ0NBQVEsR0FBUjtRQUNFLE9BQVUsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLFNBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVB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QyxDQUFDO1FBQ2xELElBQU0sQ0FBQyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDckQsSUFBTSxDQUFDLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxHQUFHLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV2RCxJQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDdkUsT0FBTyxPQUFPLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBQ0gsV0FBQztBQUFELENBQUMsQUEvSkQsSUErSkM7QUEvSlksb0JBQUkiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBwcmV0dGllclxuICogQGhpZGRlblxuICovXG5cbi8qKlxuICovXG5pbXBvcnQgKiBhcyBiaXRjb2luIGZyb20gJ0BiaXRnby91dHhvLWxpYic7XG5pbXBvcnQgKiBhcyBCaWcgZnJvbSAnYmlnLmpzJztcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHJhbmRvbUJ5dGVzIH0gZnJvbSAnY3J5cHRvJztcbmltcG9ydCAqIGFzIGRlYnVnTGliIGZyb20gJ2RlYnVnJztcbmltcG9ydCB7IEV0aGVyZXVtTGlicmFyeVVuYXZhaWxhYmxlRXJyb3IgfSBmcm9tICcuLi8uLi9lcnJvcnMnO1xuaW1wb3J0IHsgUmVxdWVzdFRyYWNlciBhcyBJUmVxdWVzdFRyYWNlciB9IGZyb20gJy4uL3R5cGVzJztcblxuY29uc3QgZGVidWcgPSBkZWJ1Z0xpYignYml0Z286djI6dXRpbCcpO1xuXG5sZXQgZXRoVXRpbDtcbmxldCBpc0V0aEF2YWlsYWJsZSA9IGZhbHNlO1xuXG5jb25zdCBldGhJbXBvcnQgPSAnZXRoZXJldW1qcy11dGlsJztcbmltcG9ydCgnZXRoZXJldW1qcy11dGlsJylcbiAgLnRoZW4oZXRoID0+IHtcbiAgICBldGhVdGlsID0gZXRoO1xuICAgIGlzRXRoQXZhaWxhYmxlID0gdHJ1ZTtcbiAgfSlcbiAgLmNhdGNoKGUgPT4ge1xuICAgIC8vIGV0aGVyZXVtIGN1cnJlbnRseSBub3Qgc3VwcG9ydGVkXG4gICAgZGVidWcoJ3VuYWJsZSB0byBsb2FkIGV0aGVyZXVtanMtdXRpbDonKTtcbiAgICBkZWJ1ZyhlLnN0YWNrKTtcbiAgfSk7XG5cbi8qKlxuICogQ3JlYXRlIGEgcmVxdWVzdCB0cmFjZXIgZm9yIHRyYWNpbmcgd29ya2Zsb3dzIHdoaWNoIGludm9sdmUgbXVsdGlwbGUgcm91bmQgdHJpcHMgdG8gdGhlIHNlcnZlclxuICovXG5leHBvcnQgY2xhc3MgUmVxdWVzdFRyYWNlciBpbXBsZW1lbnRzIElSZXF1ZXN0VHJhY2VyIHtcbiAgcHJpdmF0ZSBfc2VxID0gMDtcbiAgcHJpdmF0ZSByZWFkb25seSBfc2VlZDogQnVmZmVyO1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLl9zZWVkID0gcmFuZG9tQnl0ZXMoMTApO1xuICB9XG5cbiAgaW5jKCkge1xuICAgIHRoaXMuX3NlcSsrO1xuICB9XG5cbiAgdG9TdHJpbmcoKSB7XG4gICAgcmV0dXJuIGAke3RoaXMuX3NlZWQudG9TdHJpbmcoJ2hleCcpfS0ke18ucGFkU3RhcnQodGhpcy5fc2VxLnRvU3RyaW5nKDE2KSwgNCwgJzAnKX1gO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBVdGlsIHtcbiAgcHJpdmF0ZSBjb25zdHJ1Y3RvcigpIHt9XG5cbiAgLyoqXG4gICAqIEBkZXByZWNhdGVkXG4gICAqL1xuICBzdGF0aWMgaXNFdGhBdmFpbGFibGUoKSB7XG4gICAgcmV0dXJuIGlzRXRoQXZhaWxhYmxlO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbnZlcnQgYSBiaWcuanMgYmlnIG51bWJlciB0byBhbiBhcnJheSBvZiB1bnNpZ25lZCBieXRlc1xuICAgKiBAcGFyYW0gYm5cbiAgICogQGRlcHJlY2F0ZWRcbiAgICovXG4gIHN0YXRpYyBiblRvQnl0ZUFycmF5VW5zaWduZWQoYm46IGFueSk6IGFueSB7XG4gICAgbGV0IGJhID0gYm4uYWJzKCkudG9CeXRlQXJyYXkoKTtcbiAgICBpZiAoYmEubGVuZ3RoKSB7XG4gICAgICBpZiAoYmFbMF0gPT09IDApIHtcbiAgICAgICAgYmEgPSBiYS5zbGljZSgxKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBiYS5tYXAoZnVuY3Rpb24odikge1xuICAgICAgICByZXR1cm4gdiA8IDAgPyB2ICsgMjU2IDogdjtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBFbXB0eSBhcnJheSwgbm90aGluZyB0byBkb1xuICAgICAgcmV0dXJuIGJhO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZSB0aGUgb3V0cHV0IHNjcmlwdCBmb3IgYSBCVEMgUDJTSCBtdWx0aXNpZyBhZGRyZXNzXG4gICAqIEBwYXJhbSBtXG4gICAqIEBwYXJhbSBwdWJLZXlzXG4gICAqIEBkZXByZWNhdGVkXG4gICAqL1xuICBzdGF0aWMgcDJzaE11bHRpc2lnT3V0cHV0U2NyaXB0KG06IG51bWJlciwgcHViS2V5czogQnVmZmVyW10pIHtcbiAgICBjb25zdCByZWRlZW1TY3JpcHQgPSBiaXRjb2luLnNjcmlwdC5tdWx0aXNpZy5vdXRwdXQuZW5jb2RlKG0sIHB1YktleXMpO1xuICAgIGNvbnN0IGhhc2ggPSBiaXRjb2luLmNyeXB0by5oYXNoMTYwKHJlZGVlbVNjcmlwdCk7XG4gICAgcmV0dXJuIGJpdGNvaW4uc2NyaXB0LnNjcmlwdEhhc2gub3V0cHV0LmVuY29kZShoYXNoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVdGlsaXR5IG1ldGhvZCBmb3IgaGFuZGxpbmcgYXJndW1lbnRzIG9mIHBhZ2VhYmxlIHF1ZXJpZXNcbiAgICogQHBhcmFtIHBhcmFtc1xuICAgKiBAZGVwcmVjYXRlZFxuICAgKi9cbiAgc3RhdGljIHByZXBhcmVQYWdlYWJsZVF1ZXJ5KHBhcmFtczogeyBsaW1pdD86IG51bWJlcjsgc2tpcD86IG51bWJlciB9ID0ge30pOiB7IGxpbWl0PzogbnVtYmVyOyBza2lwPzogbnVtYmVyIH0ge1xuICAgIGNvbnN0IHF1ZXJ5OiBhbnkgPSB7fTtcbiAgICBpZiAocGFyYW1zLmxpbWl0KSB7XG4gICAgICBpZiAoIV8uaXNOdW1iZXIocGFyYW1zLmxpbWl0KSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgbGltaXQgYXJndW1lbnQsIGV4cGVjdGluZyBudW1iZXInKTtcbiAgICAgIH1cbiAgICAgIHF1ZXJ5LmxpbWl0ID0gcGFyYW1zLmxpbWl0O1xuICAgIH1cbiAgICBpZiAocGFyYW1zLnNraXApIHtcbiAgICAgIGlmICghXy5pc051bWJlcihwYXJhbXMuc2tpcCkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdpbnZhbGlkIHNraXAgYXJndW1lbnQsIGV4cGVjdGluZyBudW1iZXInKTtcbiAgICAgIH1cbiAgICAgIHF1ZXJ5LnNraXAgPSBwYXJhbXMuc2tpcDtcbiAgICB9XG4gICAgcmV0dXJuIHF1ZXJ5O1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIHJlcXVlc3QgaWRlbnRpZmllciBmb3IgdHJhY2luZyBtdWx0aS1yZXF1ZXN0IHdvcmtmbG93c1xuICAgKi9cbiAgc3RhdGljIGNyZWF0ZVJlcXVlc3RJZCgpOiBSZXF1ZXN0VHJhY2VyIHtcbiAgICByZXR1cm4gbmV3IFJlcXVlc3RUcmFjZXIoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb252ZXJ0IGEgQlRDIHhwdWIgdG8gYW4gRXRoZXJldW0gYWRkcmVzcyAod2l0aCAweCkgcHJlZml4XG4gICAqIEBwYXJhbSB4cHViXG4gICAqIEBkZXByZWNhdGVkXG4gICAqL1xuICBzdGF0aWMgeHB1YlRvRXRoQWRkcmVzcyh4cHViOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGlmICghaXNFdGhBdmFpbGFibGUpIHtcbiAgICAgIHRocm93IG5ldyBFdGhlcmV1bUxpYnJhcnlVbmF2YWlsYWJsZUVycm9yKGV0aEltcG9ydCk7XG4gICAgfVxuICAgIGNvbnN0IGhkTm9kZSA9IGJpdGNvaW4uSEROb2RlLmZyb21CYXNlNTgoeHB1Yik7XG4gICAgY29uc3QgZXRoUHVibGljS2V5ID0gaGROb2RlLmtleVBhaXIuX19RLmdldEVuY29kZWQoZmFsc2UpLnNsaWNlKDEpO1xuICAgIHJldHVybiBldGhVdGlsLmJ1ZmZlclRvSGV4KGV0aFV0aWwucHVibGljVG9BZGRyZXNzKGV0aFB1YmxpY0tleSwgZmFsc2UpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb252ZXJ0IGEgQlRDIHhwcml2IHRvIGFuIEV0aGVyZXVtIHByaXZhdGUga2V5ICh3aXRob3V0IDB4IHByZWZpeClcbiAgICogQHBhcmFtIHhwcnZcbiAgICogQGRlcHJlY2F0ZWRcbiAgICovXG4gIHN0YXRpYyB4cHJ2VG9FdGhQcml2YXRlS2V5KHhwcnY6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgaGROb2RlID0gYml0Y29pbi5IRE5vZGUuZnJvbUJhc2U1OCh4cHJ2KTtcbiAgICBjb25zdCBldGhQcml2YXRlS2V5OiBCdWZmZXIgPSBoZE5vZGUua2V5UGFpci5kLnRvQnVmZmVyKDMyKTtcbiAgICByZXR1cm4gZXRoUHJpdmF0ZUtleS50b1N0cmluZygnaGV4Jyk7XG4gIH1cblxuICAvKipcbiAgICogU2lnbiBhIG1lc3NhZ2UgdXNpbmcgRXRoZXJldW0ncyBFQ3NpZ24gbWV0aG9kIGFuZCByZXR1cm4gdGhlIHNpZ25hdHVyZSBzdHJpbmdcbiAgICogQHBhcmFtIG1zZ0hhc2hcbiAgICogQHBhcmFtIHByaXZLZXlcbiAgICogQGRlcHJlY2F0ZWRcbiAgICovXG4gIHN0YXRpYyBldGhTaWduTXNnSGFzaChtc2dIYXNoOiBzdHJpbmcsIHByaXZLZXk6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKCFpc0V0aEF2YWlsYWJsZSkge1xuICAgICAgdGhyb3cgbmV3IEV0aGVyZXVtTGlicmFyeVVuYXZhaWxhYmxlRXJyb3IoZXRoSW1wb3J0KTtcbiAgICB9XG4gICAgY29uc3Qgc2lnbmF0dXJlSW5QYXJ0cyA9IGV0aFV0aWwuZWNzaWduKFxuICAgICAgQnVmZmVyLmZyb20oZXRoVXRpbC5zdHJpcEhleFByZWZpeChtc2dIYXNoKSwgJ2hleCcpLFxuICAgICAgQnVmZmVyLmZyb20ocHJpdktleSwgJ2hleCcpXG4gICAgKTtcblxuICAgIC8vIEFzc2VtYmxlIHN0cmluZ3MgZnJvbSByLCBzIGFuZCB2XG4gICAgY29uc3QgciA9IGV0aFV0aWwuc2V0TGVuZ3RoTGVmdChzaWduYXR1cmVJblBhcnRzLnIsIDMyKS50b1N0cmluZygnaGV4Jyk7XG4gICAgY29uc3QgcyA9IGV0aFV0aWwuc2V0TGVuZ3RoTGVmdChzaWduYXR1cmVJblBhcnRzLnMsIDMyKS50b1N0cmluZygnaGV4Jyk7XG4gICAgY29uc3QgdiA9IGV0aFV0aWwuc3RyaXBIZXhQcmVmaXgoZXRoVXRpbC5pbnRUb0hleChzaWduYXR1cmVJblBhcnRzLnYpKTtcblxuICAgIC8vIENvbmNhdGVuYXRlIHRoZSByLCBzIGFuZCB2IHBhcnRzIHRvIG1ha2UgdGhlIHNpZ25hdHVyZSBzdHJpbmdcbiAgICByZXR1cm4gZXRoVXRpbC5hZGRIZXhQcmVmaXgoci5jb25jYXQocywgdikpO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbnZlcnQgZnJvbSB3ZWkgc3RyaW5nIChvciBCTikgdG8gRXRoZXIgKG11bHRpcGx5IGJ5IDFlMTgpXG4gICAqIEBwYXJhbSB3ZWlcbiAgICogQGRlcHJlY2F0ZWRcbiAgICovXG4gIHN0YXRpYyB3ZWlUb0V0aGVyU3RyaW5nKHdlaTogYW55KTogc3RyaW5nIHtcbiAgICBpZiAoIWlzRXRoQXZhaWxhYmxlKSB7XG4gICAgICB0aHJvdyBuZXcgRXRoZXJldW1MaWJyYXJ5VW5hdmFpbGFibGVFcnJvcihldGhJbXBvcnQpO1xuICAgIH1cbiAgICBsZXQgYm4gPSB3ZWk7XG4gICAgaWYgKCEod2VpIGluc3RhbmNlb2YgZXRoVXRpbC5CTikpIHtcbiAgICAgIGJuID0gbmV3IGV0aFV0aWwuQk4od2VpKTtcbiAgICB9XG4gICAgQmlnLkVfUE9TID0gMjU2O1xuICAgIEJpZy5FX05FRyA9IC0xODtcbiAgICBjb25zdCB3ZWlTdHJpbmcgPSBibi50b1N0cmluZygxMCk7XG4gICAgY29uc3QgYmlnID0gbmV3IEJpZyh3ZWlTdHJpbmcpO1xuICAgIC8vIDEwXjE4XG4gICAgY29uc3QgZXRoZXIgPSBiaWcuZGl2KCcxMDAwMDAwMDAwMDAwMDAwMDAwJyk7XG4gICAgcmV0dXJuIGV0aGVyLnRvUHJlY2lzaW9uKCk7XG4gIH1cblxuICAvKipcbiAgICogUmVjb3ZlciBhbiBldGhlcmV1bSBhZGRyZXNzIGZyb20gYSBzaWduYXR1cmUgYW5kIG1lc3NhZ2UgaGFzaFxuICAgKiBAcGFyYW0gbXNnSGFzaFxuICAgKiBAcGFyYW0gc2lnbmF0dXJlXG4gICAqIEBkZXByZWNhdGVkXG4gICAqL1xuICBzdGF0aWMgZWNSZWNvdmVyRXRoQWRkcmVzcyhtc2dIYXNoOiBzdHJpbmcsIHNpZ25hdHVyZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBtc2dIYXNoID0gZXRoVXRpbC5zdHJpcEhleFByZWZpeChtc2dIYXNoKTtcbiAgICBzaWduYXR1cmUgPSBldGhVdGlsLnN0cmlwSGV4UHJlZml4KHNpZ25hdHVyZSk7XG5cbiAgICBjb25zdCB2ID0gcGFyc2VJbnQoc2lnbmF0dXJlLnNsaWNlKDEyOCwgMTMwKSwgMTYpO1xuICAgIGNvbnN0IHIgPSBCdWZmZXIuZnJvbShzaWduYXR1cmUuc2xpY2UoMCwgNjQpLCAnaGV4Jyk7XG4gICAgY29uc3QgcyA9IEJ1ZmZlci5mcm9tKHNpZ25hdHVyZS5zbGljZSg2NCwgMTI4KSwgJ2hleCcpO1xuXG4gICAgY29uc3QgcHViS2V5ID0gZXRoVXRpbC5lY3JlY292ZXIoQnVmZmVyLmZyb20obXNnSGFzaCwgJ2hleCcpLCB2LCByLCBzKTtcbiAgICByZXR1cm4gZXRoVXRpbC5idWZmZXJUb0hleChldGhVdGlsLnB1YlRvQWRkcmVzcyhwdWJLZXkpKTtcbiAgfVxufVxuIl19