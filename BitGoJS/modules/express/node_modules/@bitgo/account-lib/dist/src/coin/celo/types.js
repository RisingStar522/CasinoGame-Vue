"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (_) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
var bignumber_js_1 = __importDefault(require("bignumber.js"));
var local_wallet_1 = require("@celo/contractkit/lib/wallets/local-wallet");
var ethereumjs_util_1 = require("ethereumjs-util");
var CeloTransaction = /** @class */ (function () {
    function CeloTransaction(tx) {
        this._feeCurrency = ethereumjs_util_1.toBuffer('0x');
        this._gatewayFeeRecipient = ethereumjs_util_1.toBuffer('0x');
        this._gatewayFee = ethereumjs_util_1.toBuffer('0x');
        this.to = ethereumjs_util_1.toBuffer([]);
        this.v = ethereumjs_util_1.toBuffer([]);
        this.r = ethereumjs_util_1.toBuffer([]);
        this.s = ethereumjs_util_1.toBuffer([]);
        this.nonce = ethereumjs_util_1.toBuffer(this.sanitizeHexString(tx.nonce));
        this.gasLimit = ethereumjs_util_1.toBuffer(this.sanitizeHexString(tx.gasLimit));
        this.gasPrice = ethereumjs_util_1.toBuffer(this.sanitizeHexString(tx.gasPrice));
        this.data = ethereumjs_util_1.toBuffer(tx.data);
        this.value = ethereumjs_util_1.toBuffer(this.sanitizeHexString(tx.value));
        if (tx.to) {
            this.to = ethereumjs_util_1.toBuffer(tx.to);
        }
        if (tx.v) {
            this.v = ethereumjs_util_1.toBuffer(tx.v);
        }
        if (tx.r) {
            this.r = ethereumjs_util_1.toBuffer(tx.r);
        }
        if (tx.s) {
            this.s = ethereumjs_util_1.toBuffer(tx.s);
        }
        if (tx.from) {
            this._from = ethereumjs_util_1.toBuffer(tx.from);
        }
        this.initRaw();
    }
    // TODO: validate if this needs to be moved to Utils class
    /**
     * Clean hex formatted values ensuring they have an even length
     *
     * @param numberValue Hex formatted number value. Example '0x01'
     * @returns sanitized value
     */
    CeloTransaction.prototype.sanitizeHexString = function (numberValue) {
        if (numberValue === '0x0') {
            return '0x';
        }
        else if (numberValue.length % 2 === 0) {
            return numberValue;
        }
        return '0x0' + numberValue.slice(2);
    };
    CeloTransaction.prototype.initRaw = function () {
        this.raw = [
            this.nonce,
            this.gasPrice,
            this.gasLimit,
            this._feeCurrency,
            this._gatewayFeeRecipient,
            this._gatewayFee,
            this.to,
            this.value,
            this.data,
            this.v,
            this.r,
            this.s,
        ];
    };
    CeloTransaction.prototype.hash = function (includeSignature) {
        var items;
        if (includeSignature) {
            items = this.raw;
        }
        else {
            items = this.raw
                .slice(0, 9)
                .concat([ethereumjs_util_1.toBuffer(this.getChainId()), ethereumjs_util_1.stripZeros(ethereumjs_util_1.toBuffer(0)), ethereumjs_util_1.stripZeros(ethereumjs_util_1.toBuffer(0))]);
        }
        return ethereumjs_util_1.rlphash(items);
    };
    CeloTransaction.prototype.getSenderAddress = function () {
        if (this._from) {
            return this._from;
        }
        var pubKey = this.getSenderPublicKey();
        this._from = ethereumjs_util_1.publicToAddress(pubKey);
        return this._from;
    };
    CeloTransaction.prototype.getSenderPublicKey = function () {
        if (this.verifySignature()) {
            // If the signature was verified successfully the _senderPubKey field is defined
            return this._senderPubKey;
        }
        throw new Error('Invalid Signature');
    };
    CeloTransaction.prototype.serialize = function () {
        return ethereumjs_util_1.rlp.encode(this.raw);
    };
    CeloTransaction.prototype.sign = function (privateKey) {
        this._signatures = [this.v, this.r, this.s, privateKey];
    };
    CeloTransaction.prototype.verifySignature = function () {
        var msgHash = this.hash(false);
        try {
            var chainId = this.getChainId();
            var v = ethereumjs_util_1.bufferToInt(this.v) - (2 * chainId + 35);
            this._senderPubKey = ethereumjs_util_1.ecrecover(msgHash, v + 27, this.r, this.s);
        }
        catch (e) {
            return false;
        }
        return !!this._senderPubKey;
    };
    CeloTransaction.prototype.getChainId = function () {
        var chainId = ethereumjs_util_1.bufferToInt(this.v);
        if (this.r.length && this.s.length) {
            chainId = (chainId - 35) >> 1;
        }
        return chainId;
    };
    return CeloTransaction;
}());
exports.CeloTransaction = CeloTransaction;
var CeloTransactionData = /** @class */ (function () {
    function CeloTransactionData(tx, deployedAddress) {
        this.tx = tx;
        this.deployedAddress = deployedAddress;
    }
    CeloTransactionData.fromJson = function (tx) {
        var chainId = ethereumjs_util_1.addHexPrefix(new bignumber_js_1.default(Number(tx.chainId)).toString(16));
        return new CeloTransactionData(new CeloTransaction({
            nonce: ethereumjs_util_1.addHexPrefix(new bignumber_js_1.default(tx.nonce).toString(16)),
            to: tx.to,
            gasPrice: ethereumjs_util_1.addHexPrefix(new bignumber_js_1.default(tx.gasPrice).toString(16)),
            gasLimit: ethereumjs_util_1.addHexPrefix(new bignumber_js_1.default(tx.gasLimit).toString(16)),
            value: ethereumjs_util_1.addHexPrefix(new bignumber_js_1.default(tx.value).toString(16)),
            data: tx.data === '0x' ? '' : tx.data,
            from: tx.from,
            s: tx.s,
            r: tx.r,
            v: tx.v || chainId,
        }), tx.deployedAddress);
    };
    CeloTransactionData.prototype.sign = function (keyPair) {
        return __awaiter(this, void 0, void 0, function () {
            var privateKey, data, celoLocalWallet, rawTransaction, nonceBigNumber;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        privateKey = ethereumjs_util_1.addHexPrefix(keyPair.getKeys().prv);
                        data = CeloTransactionData.txJsonToCeloTx(this.toJson(), keyPair.getAddress());
                        celoLocalWallet = new local_wallet_1.LocalWallet();
                        celoLocalWallet.addAccount(privateKey);
                        return [4 /*yield*/, celoLocalWallet.signTransaction(data)];
                    case 1:
                        rawTransaction = _a.sent();
                        nonceBigNumber = new bignumber_js_1.default(rawTransaction.tx.nonce);
                        rawTransaction.tx.nonce = ethereumjs_util_1.addHexPrefix(nonceBigNumber.toString(16));
                        rawTransaction.tx.data = data.data;
                        rawTransaction.tx.gasLimit = rawTransaction.tx.gas;
                        this.tx = new CeloTransaction(rawTransaction.tx);
                        this.tx.sign(ethereumjs_util_1.toBuffer(privateKey));
                        return [2 /*return*/];
                }
            });
        });
    };
    /** @inheritdoc */
    CeloTransactionData.prototype.toJson = function () {
        var result = {
            nonce: ethereumjs_util_1.bufferToInt(this.tx.nonce),
            gasPrice: new bignumber_js_1.default(ethereumjs_util_1.bufferToHex(this.tx.gasPrice), 16).toString(10),
            gasLimit: new bignumber_js_1.default(ethereumjs_util_1.bufferToHex(this.tx.gasLimit), 16).toString(10),
            value: this.tx.value.length === 0 ? '0' : new bignumber_js_1.default(ethereumjs_util_1.bufferToHex(this.tx.value), 16).toString(10),
            data: ethereumjs_util_1.bufferToHex(this.tx.data),
            id: ethereumjs_util_1.addHexPrefix(ethereumjs_util_1.bufferToHex(this.tx.hash(true))),
        };
        if (this.tx.to && this.tx.to.length) {
            result.to = ethereumjs_util_1.bufferToHex(this.tx.to);
        }
        if (this.tx.verifySignature()) {
            result.from = ethereumjs_util_1.bufferToHex(this.tx.getSenderAddress());
        }
        var chainId = this.tx.getChainId();
        if (chainId) {
            result.chainId = chainId.toString();
        }
        if (this.deployedAddress) {
            result.deployedAddress = this.deployedAddress;
        }
        this.setSignatureFields(result);
        return result;
    };
    CeloTransactionData.prototype.setSignatureFields = function (result) {
        if (this.tx.v && this.tx.v.length) {
            result.v = ethereumjs_util_1.bufferToHex(this.tx.v);
        }
        if (this.tx.r && this.tx.r.length) {
            result.r = ethereumjs_util_1.bufferToHex(this.tx.r);
        }
        if (this.tx.s && this.tx.s.length) {
            result.s = ethereumjs_util_1.bufferToHex(this.tx.s);
        }
    };
    /** @inheritdoc */
    CeloTransactionData.prototype.toSerialized = function () {
        return ethereumjs_util_1.addHexPrefix(this.tx.serialize().toString('hex'));
    };
    CeloTransactionData.txJsonToCeloTx = function (txJson, signer) {
        // the celo library requires you to specify the signer address with the from field
        return Object.assign({}, txJson, { gas: txJson.gasLimit, from: signer });
    };
    return CeloTransactionData;
}());
exports.CeloTransactionData = CeloTransactionData;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHlwZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29pbi9jZWxvL3R5cGVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSw4REFBcUM7QUFDckMsMkVBQXlFO0FBQ3pFLG1EQVV5QjtBQUl6QjtJQWtDRSx5QkFBWSxFQUFVO1FBN0JkLGlCQUFZLEdBQVcsMEJBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN0Qyx5QkFBb0IsR0FBVywwQkFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzlDLGdCQUFXLEdBQVcsMEJBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQU03QyxPQUFFLEdBQVcsMEJBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUMxQixNQUFDLEdBQVcsMEJBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN6QixNQUFDLEdBQVcsMEJBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN6QixNQUFDLEdBQVcsMEJBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQW1CdkIsSUFBSSxDQUFDLEtBQUssR0FBRywwQkFBUSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUN4RCxJQUFJLENBQUMsUUFBUSxHQUFHLDBCQUFRLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQzlELElBQUksQ0FBQyxRQUFRLEdBQUcsMEJBQVEsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDOUQsSUFBSSxDQUFDLElBQUksR0FBRywwQkFBUSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM5QixJQUFJLENBQUMsS0FBSyxHQUFHLDBCQUFRLENBQUMsSUFBSSxDQUFDLGlCQUFp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LENBQUMsR0FBRyw2QkFBVyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDbkM7SUFDSCxDQUFDO0lBRUQsa0JBQWtCO0lBQ2xCLDBDQUFZLEdBQVo7UUFDRSxPQUFPLDhCQUFZLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBRWMsa0NBQWMsR0FBN0IsVUFBOEIsTUFBYyxFQUFFLE1BQWM7UUFDMUQsa0ZBQWtGO1FBQ2xGLE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsTUFBTSxFQUFFLEVBQUUsR0FBRyxFQUFFLE1BQU0sQ0FBQyxRQUFRLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7SUFDM0UsQ0FBQztJQUNILDBCQUFDO0FBQUQsQ0FBQyxBQXBHRCxJQW9HQztBQXBHWSxrREFBbUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQmlnTnVtYmVyIGZyb20gJ2JpZ251bWJlci5qcyc7XG5pbXBvcnQgeyBMb2NhbFdhbGxldCB9IGZyb20gJ0BjZWxvL2NvbnRyYWN0a2l0L2xpYi93YWxsZXRzL2xvY2FsLXdhbGxldCc7XG5pbXBvcnQge1xuICBhZGRIZXhQcmVmaXgsXG4gIHRvQnVmZmVyLFxuICBidWZmZXJUb0hleCxcbiAgYnVmZmVyVG9JbnQsXG4gIHJscCxcbiAgcmxwaGFzaCxcbiAgc3RyaXBaZXJvcyxcbiAgZWNyZWNvdmVyLFxuICBwdWJsaWNUb0FkZHJlc3MsXG59IGZyb20gJ2V0aGVyZXVtanMtdXRpbCc7XG5pbXBvcnQgeyBFdGhMaWtlVHJhbnNhY3Rpb25EYXRhLCBUeERhdGEgfSBmcm9tICcuLi9ldGgvaWZhY2UnO1xuaW1wb3J0IHsgS2V5UGFpciB9IGZyb20gJy4uL2V0aCc7XG5cbmV4cG9ydCBjbGFzcyBDZWxvVHJhbnNhY3Rpb24ge1xuICBwcml2YXRlIHJhdzogQnVmZmVyW107XG4gIHByaXZhdGUgX2Zyb206IEJ1ZmZlcjtcbiAgcHJpdmF0ZSBfc2VuZGVyUHViS2V5PztcbiAgcHJpdmF0ZSBfc2lnbmF0dXJlczogQnVmZmVyW107XG4gIHByaXZhdGUgX2ZlZUN1cnJlbmN5OiBCdWZmZXIgPSB0b0J1ZmZlcignMHgnKTtcbiAgcHJpdmF0ZSBfZ2F0ZXdheUZlZVJlY2lwaWVudDogQnVmZmVyID0gdG9CdWZmZXIoJzB4Jyk7XG4gIHByaXZhdGUgX2dhdGV3YXlGZWU6IEJ1ZmZlciA9IHRvQnVmZmVyKCcweCcpO1xuICBub25jZTogQnVmZmVyO1xuICBnYXNMaW1pdDogQnVmZmVyO1xuICBnYXNQcmljZTogQnVmZmVyO1xuICBkYXRhOiBCdWZmZXI7XG4gIHZhbHVlOiBCdWZmZXI7XG4gIHRvOiBCdWZmZXIgPSB0b0J1ZmZlcihbXSk7XG4gIHY6IEJ1ZmZlciA9IHRvQnVmZmVyKFtdKTtcbiAgcjogQnVmZmVyID0gdG9CdWZmZXIoW10pO1xuICBzOiBCdWZmZXIgPSB0b0J1ZmZlcihbXSk7XG5cbiAgLy8gVE9ETzogdmFsaWRhdGUgaWYgdGhpcyBuZWVkcyB0byBiZSBtb3ZlZCB0byBVdGlscyBjbGFzc1xuICAvKipcbiAgICogQ2xlYW4gaGV4IGZvcm1hdHRlZCB2YWx1ZXMgZW5zdXJpbmcgdGhleSBoYXZlIGFuIGV2ZW4gbGVuZ3RoXG4gICAqXG4gICAqIEBwYXJhbSBudW1iZXJWYWx1ZSBIZXggZm9ybWF0dGVkIG51bWJlciB2YWx1ZS4gRXhhbXBsZSAnMHgwMSdcbiAgICogQHJldHVybnMgc2FuaXRpemVkIHZhbHVlXG4gICAqL1xuICBwcml2YXRlIHNhbml0aXplSGV4U3RyaW5nKG51bWJlclZhbHVlKSB7XG4gICAgaWYgKG51bWJlclZhbHVlID09PSAnMHgwJykge1xuICAgICAgcmV0dXJuICcweCc7XG4gICAgfSBlbHNlIGlmIChudW1iZXJWYWx1ZS5sZW5ndGggJSAyID09PSAwKSB7XG4gICAgICByZXR1cm4gbnVtYmVyVmFsdWU7XG4gICAgfVxuICAgIHJldHVybiAnMHgwJyArIG51bWJlclZhbHVlLnNsaWNlKDIpO1xuICB9XG5cbiAgY29uc3RydWN0b3IodHg6IFR4RGF0YSkge1xuICAgIHRoaXMubm9uY2UgPSB0b0J1ZmZlcih0aGlzLnNhbml0aXplSGV4U3RyaW5nKHR4Lm5vbmNlKSk7XG4gICAgdGhpcy5nYXNMaW1pdCA9IHRvQnVmZmVyKHRoaXMuc2FuaXRpemVIZXhTdHJpbmcodHguZ2FzTGltaXQpKTtcbiAgICB0aGlzLmdhc1ByaWNlID0gdG9CdWZmZXIodGhpcy5zYW5pdGl6ZUhleFN0cmluZyh0eC5nYXNQcmljZSkpO1xuICAgIHRoaXMuZGF0YSA9IHRvQnVmZmVyKHR4LmRhdGEpO1xuICAgIHRoaXMudmFsdWUgPSB0b0J1ZmZlcih0aGlzLnNhbml0aXplSGV4U3RyaW5nKHR4LnZhbHVlKSk7XG4gICAgaWYgKHR4LnRvKSB7XG4gICAgICB0aGlzLnRvID0gdG9CdWZmZXIodHgudG8pO1xuICAgIH1cbiAgICBpZiAodHgudikge1xuICAgICAgdGhpcy52ID0gdG9CdWZmZXIodHgudik7XG4gICAgfVxuICAgIGlmICh0eC5yKSB7XG4gICAgICB0aGlzLnIgPSB0b0J1ZmZlcih0eC5yKTtcbiAgICB9XG4gICAgaWYgKHR4LnMpIHtcbiAgICAgIHRoaXMucyA9IHRvQnVmZmVyKHR4LnMpO1xuICAgIH1cbiAgICBpZiAodHguZnJvbSkge1xuICAgICAgdGhpcy5fZnJvbSA9IHRvQnVmZmVyKHR4LmZyb20pO1xuICAgIH1cbiAgICB0aGlzLmluaXRSYXcoKTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdFJhdygpIHtcbiAgICB0aGlzLnJhdyA9IFtcbiAgICAgIHRoaXMubm9uY2UsXG4gICAgICB0aGlzLmdhc1ByaWNlLFxuICAgICAgdGhpcy5nYXNMaW1pdCxcbiAgICAgIHRoaXMuX2ZlZUN1cnJlbmN5LFxuICAgICAgdGhpcy5fZ2F0ZXdheUZlZVJlY2lwaWVudCxcbiAgICAgIHRoaXMuX2dhdGV3YXlGZWUsXG4gICAgICB0aGlzLnRvLFxuICAgICAgdGhpcy52YWx1ZSxcbiAgICAgIHRoaXMuZGF0YSxcbiAgICAgIHRoaXMudixcbiAgICAgIHRoaXMucixcbiAgICAgIHRoaXMucyxcbiAgICBdO1xuICB9XG5cbiAgaGFzaChpbmNsdWRlU2lnbmF0dXJlPzogYm9vbGVhbik6IEJ1ZmZlciB7XG4gICAgbGV0IGl0ZW1zO1xuICAgIGlmIChpbmNsdWRlU2lnbmF0dXJlKSB7XG4gICAgICBpdGVtcyA9IHRoaXMucmF3O1xuICAgIH0gZWxzZSB7XG4gICAgICBpdGVtcyA9IHRoaXMucmF3XG4gICAgICAgIC5zbGljZSgwLCA5KVxuICAgICAgICAuY29uY2F0KFt0b0J1ZmZlcih0aGlzLmdldENoYWluSWQoKSksIHN0cmlwWmVyb3ModG9CdWZmZXIoMCkpLCBzdHJpcFplcm9zKHRvQnVmZmVyKDApKV0pO1xuICAgIH1cblxuICAgIHJldHVybiBybHBoYXNoKGl0ZW1zKTtcbiAgfVxuXG4gIGdldFNlbmRlckFkZHJlc3MoKTogQnVmZmVyIHtcbiAgICBpZiAodGhpcy5fZnJvbSkge1xuICAgICAgcmV0dXJuIHRoaXMuX2Zyb207XG4gICAgfVxuICAgIGNvbnN0IHB1YktleSA9IHRoaXMuZ2V0U2VuZGVyUHVibGljS2V5KCk7XG4gICAgdGhpcy5fZnJvbSA9IHB1YmxpY1RvQWRkcmVzcyhwdWJLZXkpO1xuICAgIHJldHVybiB0aGlzLl9mcm9tO1xuICB9XG5cbiAgZ2V0U2VuZGVyUHVibGljS2V5KCkge1xuICAgIGlmICh0aGlzLnZlcmlmeVNpZ25hdHVyZSgpKSB7XG4gICAgICAvLyBJZiB0aGUgc2lnbmF0dXJlIHdhcyB2ZXJpZmllZCBzdWNjZXNzZnVsbHkgdGhlIF9zZW5kZXJQdWJLZXkgZmllbGQgaXMgZGVmaW5lZFxuICAgICAgcmV0dXJuIHRoaXMuX3NlbmRlclB1YktleTtcbiAgICB9XG4gICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIFNpZ25hdHVyZScpO1xuICB9XG5cbiAgc2VyaWFsaXplKCk6IEJ1ZmZlciB7XG4gICAgcmV0dXJuIHJscC5lbmNvZGUodGhpcy5yYXcpO1xuICB9XG5cbiAgc2lnbihwcml2YXRlS2V5OiBCdWZmZXIpOiB2b2lkIHtcbiAgICB0aGlzLl9zaWduYXR1cmVzID0gW3RoaXMudiwgdGhpcy5yLCB0aGlzLnMsIHByaXZhdGVLZXldO1xuICB9XG5cbiAgdmVyaWZ5U2lnbmF0dXJlKCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IG1zZ0hhc2ggPSB0aGlzLmhhc2goZmFsc2UpO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBjaGFpbklkID0gdGhpcy5nZXRDaGFpbklkKCk7XG4gICAgICBjb25zdCB2ID0gYnVmZmVyVG9JbnQodGhpcy52KSAtICgyICogY2hhaW5JZCArIDM1KTtcbiAgICAgIHRoaXMuX3NlbmRlclB1YktleSA9IGVjcmVjb3Zlcihtc2dIYXNoLCB2ICsgMjcsIHRoaXMuciwgdGhpcy5zKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiAhIXRoaXMuX3NlbmRlclB1YktleTtcbiAgfVxuXG4gIGdldENoYWluSWQoKTogbnVtYmVyIHtcbiAgICBsZXQgY2hhaW5JZCA9IGJ1ZmZlclRvSW50KHRoaXMudik7XG4gICAgaWYgKHRoaXMuci5sZW5ndGggJiYgdGhpcy5zLmxlbmd0aCkge1xuICAgICAgY2hhaW5JZCA9IChjaGFpbklkIC0gMzUpID4+IDE7XG4gICAgfVxuICAgIHJldHVybiBjaGFpbklkO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBDZWxvVHJhbnNhY3Rpb25EYXRhIGltcGxlbWVudHMgRXRoTGlrZVRyYW5zYWN0aW9uRGF0YSB7XG4gIHByaXZhdGUgdHg6IENlbG9UcmFuc2FjdGlvbjtcbiAgcHJpdmF0ZSBkZXBsb3llZEFkZHJlc3M/OiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IodHg6IENlbG9UcmFuc2FjdGlvbiwgZGVwbG95ZWRBZGRyZXNzPzogc3RyaW5nKSB7XG4gICAgdGhpcy50eCA9IHR4O1xuICAgIHRoaXMuZGVwbG95ZWRBZGRyZXNzID0gZGVwbG95ZWRBZGRyZXNzO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBmcm9tSnNvbih0eDogVHhEYXRhKTogQ2Vsb1RyYW5zYWN0aW9uRGF0YSB7XG4gICAgY29uc3QgY2hhaW5JZCA9IGFkZEhleFByZWZpeChuZXcgQmlnTnVtYmVyKE51bWJlcih0eC5jaGFpbklkKSkudG9TdHJpbmcoMTYpKTtcbiAgICByZXR1cm4gbmV3IENlbG9UcmFuc2FjdGlvbkRhdGEoXG4gICAgICBuZXcgQ2Vsb1RyYW5zYWN0aW9uKHtcbiAgICAgICAgbm9uY2U6IGFkZEhleFByZWZpeChuZXcgQmlnTnVtYmVyKHR4Lm5vbmNlKS50b1N0cmluZygxNikpLFxuICAgICAgICB0bzogdHgudG8sXG4gICAgICAgIGdhc1ByaWNlOiBhZGRIZXhQcmVmaXgobmV3IEJpZ051bWJlcih0eC5nYXNQcmljZSkudG9TdHJpbmcoMTYpKSxcbiAgICAgICAgZ2FzTGltaXQ6IGFkZEhleFByZWZpeChuZXcgQmlnTnVtYmVyKHR4Lmdhc0xpbWl0KS50b1N0cmluZygxNikpLFxuICAgICAgICB2YWx1ZTogYWRkSGV4UHJlZml4KG5ldyBCaWdOdW1iZXIodHgudmFsdWUpLnRvU3RyaW5nKDE2KSksXG4gICAgICAgIGRhdGE6IHR4LmRhdGEgPT09ICcweCcgPyAnJyA6IHR4LmRhdGEsXG4gICAgICAgIGZyb206IHR4LmZyb20sXG4gICAgICAgIHM6IHR4LnMsXG4gICAgICAgIHI6IHR4LnIsXG4gICAgICAgIHY6IHR4LnYgfHwgY2hhaW5JZCxcbiAgICAgIH0pLFxuICAgICAgdHguZGVwbG95ZWRBZGRyZXNzLFxuICAgICk7XG4gIH1cblxuICBhc3luYyBzaWduKGtleVBhaXI6IEtleVBhaXIpIHtcbiAgICBjb25zdCBwcml2YXRlS2V5ID0gYWRkSGV4UHJlZml4KGtleVBhaXIuZ2V0S2V5cygpLnBydiBhcyBzdHJpbmcpO1xuICAgIGNvbnN0IGRhdGEgPSBDZWxvVHJhbnNhY3Rpb25EYXRhLnR4SnNvblRvQ2Vsb1R4KHRoaXMudG9Kc29uKCksIGtleVBhaXIuZ2V0QWRkcmVzcygpKTtcblxuICAgIGNvbnN0IGNlbG9Mb2NhbFdhbGxldCA9IG5ldyBMb2NhbFdhbGxldCgpO1xuICAgIGNlbG9Mb2NhbFdhbGxldC5hZGRBY2NvdW50KHByaXZhdGVLZXkpO1xuICAgIGNvbnN0IHJhd1RyYW5zYWN0aW9uID0gYXdhaXQgY2Vsb0xvY2FsV2FsbGV0LnNpZ25UcmFuc2FjdGlvbihkYXRhKTtcblxuICAgIGNvbnN0IG5vbmNlQmlnTnVtYmVyID0gbmV3IEJpZ051bWJlcihyYXdUcmFuc2FjdGlvbi50eC5ub25jZSk7XG4gICAgcmF3VHJhbnNhY3Rpb24udHgubm9uY2UgPSBhZGRIZXhQcmVmaXgobm9uY2VCaWdOdW1iZXIudG9TdHJpbmcoMTYpKTtcbiAgICByYXdUcmFuc2FjdGlvbi50eC5kYXRhID0gZGF0YS5kYXRhO1xuICAgIHJhd1RyYW5zYWN0aW9uLnR4Lmdhc0xpbWl0ID0gcmF3VHJhbnNhY3Rpb24udHguZ2FzO1xuICAgIHRoaXMudHggPSBuZXcgQ2Vsb1RyYW5zYWN0aW9uKHJhd1RyYW5zYWN0aW9uLnR4KTtcbiAgICB0aGlzLnR4LnNpZ24odG9CdWZmZXIocHJpdmF0ZUtleSkpO1xuICB9XG5cbiAgLyoqIEBpbmhlcml0ZG9jICovXG4gIHRvSnNvbigpOiBUeERhdGEge1xuICAgIGNvbnN0IHJlc3VsdDogVHhEYXRhID0ge1xuICAgICAgbm9uY2U6IGJ1ZmZlclRvSW50KHRoaXMudHgubm9uY2UpLFxuICAgICAgZ2FzUHJpY2U6IG5ldyBCaWdOdW1iZXIoYnVmZmVyVG9IZXgodGhpcy50eC5nYXNQcmljZSksIDE2KS50b1N0cmluZygxMCksXG4gICAgICBnYXNMaW1pdDogbmV3IEJpZ051bWJlcihidWZmZXJUb0hleCh0aGlzLnR4Lmdhc0xpbWl0KSwgMTYpLnRvU3RyaW5nKDEwKSxcbiAgICAgIHZhbHVlOiB0aGlzLnR4LnZhbHVlLmxlbmd0aCA9PT0gMCA/ICcwJyA6IG5ldyBCaWdOdW1iZXIoYnVmZmVyVG9IZXgodGhpcy50eC52YWx1ZSksIDE2KS50b1N0cmluZygxMCksXG4gICAgICBkYXRhOiBidWZmZXJUb0hleCh0aGlzLnR4LmRhdGEpLFxuICAgICAgaWQ6IGFkZEhleFByZWZpeChidWZmZXJUb0hleCh0aGlzLnR4Lmhhc2godHJ1ZSkpKSxcbiAgICB9O1xuXG4gICAgaWYgKHRoaXMudHgudG8gJiYgdGhpcy50eC50by5sZW5ndGgpIHtcbiAgICAgIHJlc3VsdC50byA9IGJ1ZmZlclRvSGV4KHRoaXMudHgudG8pO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnR4LnZlcmlmeVNpZ25hdHVyZSgpKSB7XG4gICAgICByZXN1bHQuZnJvbSA9IGJ1ZmZlclRvSGV4KHRoaXMudHguZ2V0U2VuZGVyQWRkcmVzcygpKTtcbiAgICB9XG5cbiAgICBjb25zdCBjaGFpbklkID0gdGhpcy50eC5nZXRDaGFpbklkKCk7XG4gICAgaWYgKGNoYWluSWQpIHtcbiAgICAgIHJlc3VsdC5jaGFpbklkID0gY2hhaW5JZC50b1N0cmluZygpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmRlcGxveWVkQWRkcmVzcykge1xuICAgICAgcmVzdWx0LmRlcGxveWVkQWRkcmVzcyA9IHRoaXMuZGVwbG95ZWRBZGRyZXNzO1xuICAgIH1cblxuICAgIHRoaXMuc2V0U2lnbmF0dXJlRmllbGRzKHJlc3VsdCk7XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRTaWduYXR1cmVGaWVsZHMocmVzdWx0OiBUeERhdGEpOiB2b2lkIHtcbiAgICBpZiAodGhpcy50eC52ICYmIHRoaXMudHgudi5sZW5ndGgpIHtcbiAgICAgIHJlc3VsdC52ID0gYnVmZmVyVG9IZXgodGhpcy50eC52KTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy50eC5yICYmIHRoaXMudHguci5sZW5ndGgpIHtcbiAgICAgIHJlc3VsdC5yID0gYnVmZmVyVG9IZXgodGhpcy50eC5yKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy50eC5zICYmIHRoaXMudHgucy5sZW5ndGgpIHtcbiAgICAgIHJlc3VsdC5zID0gYnVmZmVyVG9IZXgodGhpcy50eC5zKTtcbiAgICB9XG4gIH1cblxuICAvKiogQGluaGVyaXRkb2MgKi9cbiAgdG9TZXJpYWxpemVkKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGFkZEhleFByZWZpeCh0aGlzLnR4LnNlcmlhbGl6ZSgpLnRvU3RyaW5nKCdoZXgnKSk7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyB0eEpzb25Ub0NlbG9UeCh0eEpzb246IFR4RGF0YSwgc2lnbmVyOiBzdHJpbmcpOiBDZWxvTGlicmFyeVR4IHtcbiAgICAvLyB0aGUgY2VsbyBsaWJyYXJ5IHJlcXVpcmVzIHlvdSB0byBzcGVjaWZ5IHRoZSBzaWduZXIgYWRkcmVzcyB3aXRoIHRoZSBmcm9tIGZpZWxkXG4gICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIHR4SnNvbiwgeyBnYXM6IHR4SnNvbi5nYXNMaW1pdCwgZnJvbTogc2lnbmVyIH0pO1xuICB9XG59XG5cbi8vIHRoZSBzYW1lIGFzIG5vcm1hbCB0eGRhdGEgYnV0IGdhc0xpbWl0IGlzIGNhbGxlZCBnYXNcbmludGVyZmFjZSBDZWxvTGlicmFyeVR4IGV4dGVuZHMgVHhEYXRhIHtcbiAgZ2FzOiBzdHJpbmc7XG59XG4iXX0=